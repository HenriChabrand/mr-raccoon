function getResult(callback, json) { var token = 'AIzaSyDLGejsdWAYT5BKgqqvmRQUoWtT34OWfE8'; console.log('call_id : api_1_call_5'); var input = json.input; var all_required = false; if(input.locationLike){ all_required = true; } if(all_required){ var call = 'https://maps.googleapis.com/maps/api/geocode/json?key='+token+'&address='+input.locationLike+''; require('request')(call, function (error, response, body) { if (!error && response.statusCode == 200) { var info = JSON.parse(body); if(!json.input.location){ json.input.location = {}; }json.input.location.longName = info.results[0].address_components[0].long_name; if(!json.input.location){ json.input.location = {}; }json.input.location.shortName = info.results[0].address_components[0].short_name; if(!json.input.location){ json.input.location = {}; }json.input.location.formattedAddress = info.results[0].formatted_address; if(!json.input.geoCode){ json.input.geoCode = {}; }json.input.geoCode.lat = info.results[0].geometry.location.lat; if(!json.input.geoCode){ json.input.geoCode = {}; }json.input.geoCode.lng = info.results[0].geometry.location.lng; if(!json.input.google){ json.input.google = {}; }json.input.google.placeId = info.results[0].place_id; if(!json.input.location){ json.input.location = {}; }json.input.location.type = info.results[0].types[0]; json.index = json.index+1; if(json.step[json.index].nb=='end'){ var query_array = json.query.split('.'); var output = json.input; for(var i= 0; i < query_array.length; i++){ output = output[query_array[i]]; } if(output){ callback(output); }else{ callback(json.input); } }else{ var action_module = require('./'+ json.step[json.index].call_id + '.js'); action_module.getResult(function(result) { callback(result); },json); } }else{ callback('the request failed'); } }); } } exports.getResult = getResult;
